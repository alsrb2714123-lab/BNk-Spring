<div th:replace="~{member/_head.html}"></div>
<div class="login-container">
    <!-- 탭 메뉴 -->
    <div class="tab-menu">
        <p>홈페이지 회원</p>
    </div>
    <!-- 홈페이지 회원 -->
    <div id="homepage" class="tab-content center-content">
        <form class="login-form" th:action="@{/login}" method="post">
            <input type="text" name="userid" placeholder="아이디를 입력해주세요" required>

            <input type="password" name="userpw" id="passwordInput" placeholder="비밀번호를 입력해주세요" required>

            <label><input type="checkbox" id="useMouseInput"> 마우스로 입력</label>

            <div id="virtualKeyboardBox">
                <div class="simple-keyboard"></div>
            </div>

            <div th:if="${param.error}" class="error-message" style="color: #c6281f; font-size: 14px; margin-bottom: 10px;">
                아이디 또는 비밀번호를 확인해주세요.
            </div>

            <button type="submit" class="btn-red">로그인</button>

            <div class="link-group">
                <a th:href="@{/find-id}">아이디조회</a> |
                <a th:href="@{/find-password}">비밀번호변경</a> |
                <a th:href="@{/member/type}">회원가입</a>
            </div>
        </form>
        <div class="info">
            홈페이지회원 로그인은 일부 서비스에 한하여 이용하실 수 있습니다.
        </div>
    </div>
</div>
<div th:replace="~{member/_tail.html}"></div>

<script>
    let myKeyboard; // 키보드 객체 저장 변수

    document.addEventListener('DOMContentLoaded', function() {
        const checkbox = document.getElementById('useMouseInput');
        const keyboardBox = document.getElementById('virtualKeyboardBox');
        const inputElement = document.getElementById('passwordInput');

        // 1. 체크박스 변경 감지
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                // 체크되면: 키보드 보이기 + 랜덤 배열 생성 + 키보드 초기화
                keyboardBox.style.display = 'block';
                initKeyboard();
            } else {
                // 체크 해제되면: 키보드 숨기기
                keyboardBox.style.display = 'none';
            }
        });

        // 2. 키보드 초기화 및 랜덤 배치 함수
        function initKeyboard() {
            // 숫자 0~9를 배열로 만들어서 무작위로 섞음 (Shuffle)
            const numbers = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'];
            shuffleArray(numbers);

            // 섞인 숫자를 키보드 레이아웃 형식 문자열로 변환
            // 예: "1 2 3 4 5 6 7 8 9 0" -> "5 0 2 8 1 9 3 7 4 6"
            const numRow = numbers.join(" ");

            // 키보드 옵션 설정
            const keyboardOptions = {
                onChange: input => onChange(input),
                onKeyPress: button => onKeyPress(button),
                layout: {
                    // default 레이아웃 정의 (숫자줄을 변수(numRow)로 대체)
                    default: [
                        numRow + " {bksp}", // 첫째 줄: 랜덤 숫자 + 백스페이스
                        "q w e r t y u i o p",
                        "a s d f g h j k l",
                        "{shift} z x c v b n m",
                        "{space}"
                    ],
                    shift: [
                        numRow + " {bksp}",
                        "Q W E R T Y U I O P",
                        "A S D F G H J K L",
                        "{shift} Z X C V B N M",
                        "{space}"
                    ]
                },
                display: {
                    "{bksp}": "⌫",
                    "{shift}": "⇧",
                    "{space}": "SPACE",
                },
                // 숫자키에만 특별한 클래스를 줘서 색상을 다르게 함 (선택사항)
                buttonTheme: [
                    {
                        class: "hg-button-numpad",
                        buttons: numRow
                    }
                ]
            };

            // 이미 키보드가 있으면 제거하고 새로 생성 (재랜덤화 위해)
            if(myKeyboard) myKeyboard.destroy();

            // 키보드 생성 (클래스명 .simple-keyboard 에 연결)
            myKeyboard = new SimpleKeyboard.default(keyboardOptions);
        }

        // 3. 입력 처리 (키보드 누를 때마다 input 값 업데이트)
        function onChange(input) {
            inputElement.value = input;
        }

        function onKeyPress(button) {
            // 시프트 키 처리 등 특수 기능 필요 시 여기에 작성
            if (button === "{shift}" || button === "{lock}") {
                handleShift();
            }
        }

        function handleShift() {
            let currentLayout = myKeyboard.options.layoutName;
            let shiftToggle = currentLayout === "default" ? "shift" : "default";
            myKeyboard.setOptions({
                layoutName: shiftToggle
            });
        }

        // 4. 배열 무작위 섞기 (Fisher-Yates Shuffle 알고리즘)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // (추가) 사용자가 물리 키보드로 입력할 때도 가상 키보드 내부 상태 동기화
        inputElement.addEventListener("input", event => {
            if(myKeyboard) {
                myKeyboard.setInput(event.target.value);
            }
        });
    });
</script>