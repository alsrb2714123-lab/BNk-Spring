<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결재(승인) 관리 - 은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/adminproduct.css}">
    <link rel="stylesheet" th:href="@{/css/admin/approval_styles.css}">
</head>
<body>
    <!-- 사이드바 Fragment -->
    <div th:replace="~{admin/_sidebar :: sidebar('approval')}"></div>

    <div class="main-content">
        <!-- 헤더 Fragment -->
        <div th:replace="~{admin/_header :: header}"></div>

    <div class="main-content-body">
        <div class="container">
            <header class="page-header">
                <h1>결재(승인) 관리</h1>
            </header>

            <section class="section-block approval-overview">
                <h2 class="section-title">상품 결재 현황</h2>
                <div class="stat-grid">
                    <div class="stat-card">
                        <span class="stat-label">전체 요청</span>
                        <span class="stat-value" data-metric="total">0건</span>
                        <span class="stat-subtext">최근 30일</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">대기</span>
                        <span class="stat-value" data-metric="pending">0건</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">승인</span>
                        <span class="stat-value" data-metric="approved">0건</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">반려</span>
                        <span class="stat-value" data-metric="rejected">0건</span>
                    </div>
                </div>
                <ul class="summary-list">
                    <li>상품 신규 등록 및 수정 요청만 확인합니다.</li>
                    <li>승인 시 즉시 상품 관리 화면에 반영됩니다.</li>
                </ul>
            </section>

            <section class="section-block approval-filter">
                <h2 class="section-title">결재 요청 검색</h2>
                <div class="search-section">
                    <form th:action="@{/admin/approval}" method="get" style="margin: 0;">
                        <table class="search-table">
                            <tbody>
                                <tr>
                                    <td class="search-label">검색어</td>
                                    <td class="search-inputs">
                                        <input type="text" class="form-input search-input-large" id="filterKeyword" name="keyword" placeholder="결재 ID 또는 요청자를 입력하세요" th:value="${pageRequestDTO != null ? pageRequestDTO.keyword : ''}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="search-label">상태</td>
                                    <td class="search-inputs">
                                        <select class="form-select search-select-medium" id="filterStatus" name="status">
                                            <option value="">전체</option>
                                            <option value="대기">대기</option>
                                            <option value="승인">승인</option>
                                            <option value="반려">반려</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="search-label">요청자</td>
                                    <td class="search-inputs">
                                        <input type="text" class="form-input search-input-large" id="filterRequester" name="requester" placeholder="요청자 이름을 입력하세요" th:value="${pageRequestDTO != null ? pageRequestDTO.requester : ''}">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="search-label">기간</td>
                                    <td class="search-inputs">
                                        <input type="date" class="form-input search-select-medium" id="filterDateFrom" name="dateFrom" th:value="${pageRequestDTO != null ? pageRequestDTO.dateFrom : ''}">
                                        <span style="margin: 0 10px;">~</span>
                                        <input type="date" class="form-input search-select-medium" id="filterDateTo" name="dateTo" th:value="${pageRequestDTO != null ? pageRequestDTO.dateTo : ''}">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="search-actions">
                            <button type="button" class="btn btn-secondary" th:onclick="|location.href='@{/admin/approval}'|">초기화</button>
                            <button type="submit" class="btn btn-search">조회</button>
                        </div>
                    </form>
                </div>
            </section>

            <section class="section-block">
                <h2 class="section-title">상품 결재 대기 목록</h2>
                <div class="history-table">
                    <div class="table-info">
                        <span>총 <strong>2</strong>건</span>
                        <span class="pagination-info">1 / 1 page</span>
                    </div>
                    <table class="fund-table" id="pendingTable">
                        <thead>
                        <tr>
                            <th>결재 ID</th>
                            <th>상품명</th>
                            <th>결재 유형</th>
                            <th>요청자</th>
                            <th>요청 일시</th>
                            <th>상태</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr class="approval-row selected" data-id="APR-2024-021" data-product="BNK 스마트 적금" data-product-code="BNK-001" data-type="상품 신규 등록" data-requester="김운용" data-requested="2024-05-02 09:30" data-status="대기" data-status-key="pending" data-reason="신규 BNK 스마트 적금 상품 출시 결재 요청입니다." data-attachment="BNK_스마트적금_상품설명서.pdf" data-attachment-url="#">
                            <td class="table-ellipsis">APR-2024-021</td>
                            <td class="table-ellipsis">BNK 스마트 적금</td>
                            <td class="table-ellipsis emphasis">상품 신규 등록</td>
                            <td class="table-ellipsis">김운용</td>
                            <td class="table-ellipsis">2024-05-02 09:30</td>
                            <td class="table-ellipsis"><span class="status-badge status-pending">대기</span></td>
                        </tr>
                        <tr class="approval-row" data-id="APR-2024-020" data-product="BNK 기업대출상품" data-product-code="BNK-102" data-type="상품 수정" data-requester="박심사" data-requested="2024-05-01 14:10" data-status="대기" data-status-key="pending" data-reason="기업대출상품 금리 조건 변경에 대한 승인 요청입니다." data-attachment="기업대출상품_변경내역.pdf" data-attachment-url="#">
                            <td class="table-ellipsis">APR-2024-020</td>
                            <td class="table-ellipsis">BNK 기업대출상품</td>
                            <td class="table-ellipsis emphasis">상품 수정</td>
                            <td class="table-ellipsis">박심사</td>
                            <td class="table-ellipsis">2024-05-01 14:10</td>
                            <td class="table-ellipsis"><span class="status-badge status-pending">대기</span></td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="pagination">
                        <button class="page-btn prev" disabled>&lt;</button>
                        <div class="page-numbers">
                            <button class="page-number active">1</button>
                        </div>
                        <button class="page-btn next" disabled>&gt;</button>
                    </div>
                </div>
            </section>

            <div class="split-layout">
                <section class="section-block approval-detail">
                    <h2 class="section-title">결재 상세</h2>
                    <div class="detail-panel">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">결재 ID</span>
                                <span class="detail-value" id="detailId">APR-2024-021</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">결재 유형</span>
                                <span class="detail-value" id="detailType">상품 신규 등록</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">상품명</span>
                                <span class="detail-value" id="detailProduct">BNK 스마트 적금</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">상품 코드</span>
                                <span class="detail-value" id="detailProductCode">BNK-001</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">요청자</span>
                                <span class="detail-value" id="detailRequester">김운용</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">요청 일시</span>
                                <span class="detail-value" id="detailRequestedAt">2024-05-02 09:30</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">상태</span>
                                <span class="detail-value" id="detailStatus"><span class="status-badge status-pending">대기</span></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">첨부 문서</span>
                                <a href="#" class="detail-link" id="detailAttachment">BNK_스마트적금_상품설명서.pdf</a>
                            </div>
                            <div class="detail-item span-2">
                                <span class="detail-label">요청 사유</span>
                                <span class="detail-desc" id="detailReason">신규 BNK 스마트 적금 상품 출시 결재 요청입니다.</span>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="approvalComment">결재 의견</label>
                            <textarea id="approvalComment" placeholder="승인 또는 반려 사유를 입력하세요."></textarea>
                        </div>
                        <div class="error-message" id="approvalError" aria-live="polite"></div>
                        <div class="detail-actions">
                            <button type="button" class="btn btn-red" id="approveButton">승인</button>
                            <button type="button" class="btn btn-secondary" id="rejectButton">반려</button>
                        </div>
                    </div>
                </section>

                <section class="section-block approval-history">
                    <h2 class="section-title">최근 결재 이력</h2>
                    <div class="history-table">
                        <div class="table-info">
                            <span>총 <strong>2</strong>건</span>
                            <span class="pagination-info">1 / 1 page</span>
                        </div>
                        <table class="fund-table" id="historyTable">
                            <thead>
                            <tr>
                                <th>결재 ID</th>
                                <th>상품명</th>
                                <th>결재 유형</th>
                                <th>최종 처리자</th>
                                <th>처리 일시</th>
                                <th>결과</th>
                                <th>비고</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr data-status-key="approved">
                                <td class="table-ellipsis">APR-2024-013</td>
                                <td class="table-ellipsis">BNK 더드림 펀드</td>
                                <td class="table-ellipsis emphasis">상품 신규 등록</td>
                                <td class="table-ellipsis">홍관리</td>
                                <td class="table-ellipsis">2024-04-20 14:05</td>
                                <td class="table-ellipsis"><span class="status-badge status-approved">승인</span></td>
                                <td class="remark">상품 신규 등록 승인</td>
                            </tr>
                            <tr data-status-key="rejected">
                                <td class="table-ellipsis">APR-2024-012</td>
                                <td class="table-ellipsis">BNK 하모니 적립식</td>
                                <td class="table-ellipsis emphasis">상품 수정</td>
                                <td class="table-ellipsis">홍관리</td>
                                <td class="table-ellipsis">2024-04-19 11:20</td>
                                <td class="table-ellipsis"><span class="status-badge status-rejected">반려</span></td>
                                <td class="remark">근거 자료 부족</td>
                            </tr>
                            </tbody>
                        </table>
                        <div class="pagination">
                            <button class="page-btn prev" disabled>&lt;</button>
                            <div class="page-numbers">
                                <button class="page-number active">1</button>
                            </div>
                            <button class="page-btn next" disabled>&gt;</button>
                        </div>
                    </div>
                </section>
            </div>
            <!-- 푸터 영역 -->
            <footer class="admin-footer"></footer>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = Array.from(document.querySelectorAll('.approval-row'));
        const detailId = document.getElementById('detailId');
        const detailType = document.getElementById('detailType');
        const detailRequester = document.getElementById('detailRequester');
        const detailRequestedAt = document.getElementById('detailRequestedAt');
        const detailStatus = document.getElementById('detailStatus');
        const detailReason = document.getElementById('detailReason');
        const detailAttachment = document.getElementById('detailAttachment');
        const detailProduct = document.getElementById('detailProduct');
        const detailProductCode = document.getElementById('detailProductCode');
        const commentField = document.getElementById('approvalComment');
        const errorBox = document.getElementById('approvalError');
        const approveButton = document.getElementById('approveButton');
        const rejectButton = document.getElementById('rejectButton');
        const overviewMap = {
            total: document.querySelector('[data-metric="total"]'),
            pending: document.querySelector('[data-metric="pending"]'),
            approved: document.querySelector('[data-metric="approved"]'),
            rejected: document.querySelector('[data-metric="rejected"]')
        };

        function setDetail(row) {
            rows.forEach((r) => r.classList.remove('selected'));
            row.classList.add('selected');

            detailId.textContent = row.dataset.id;
            detailType.textContent = row.dataset.type || '';
            detailRequester.textContent = row.dataset.requester;
            detailRequestedAt.textContent = row.dataset.requested;

            const statusKey = row.dataset.statusKey || 'pending';
            const statusLabel = row.dataset.status || row.dataset.statusKey;
            detailStatus.innerHTML = `<span class="status-badge status-${statusKey}">${statusLabel}</span>`;

            detailReason.textContent = row.dataset.reason || '';
            if (row.dataset.attachment) {
                detailAttachment.textContent = row.dataset.attachment;
                detailAttachment.href = row.dataset.attachmentUrl || '#';
                detailAttachment.style.display = '';
            } else {
                detailAttachment.textContent = '첨부 파일 없음';
                detailAttachment.removeAttribute('href');
            }
            detailProduct.textContent = row.dataset.product || '-';
            detailProductCode.textContent = row.dataset.productCode || '-';

            commentField.value = '';
            errorBox.textContent = '';
        }

        function updateOverviewCounts() {
            const counts = { total: 0, pending: 0, approved: 0, rejected: 0 };

            document.querySelectorAll('#pendingTable tbody tr').forEach((row) => {
                const key = row.dataset.statusKey || 'pending';
                counts.total += 1;
                if (counts[key] !== undefined) counts[key] += 1;
            });

            document.querySelectorAll('#historyTable tbody tr').forEach((row) => {
                const key = row.dataset.statusKey;
                counts.total += 1;
                if (counts[key] !== undefined) counts[key] += 1;
            });

            Object.entries(overviewMap).forEach(([key, el]) => {
                if (el) {
                    el.textContent = `${counts[key]}건`;
                }
            });
        }

        rows.forEach((row) => {
            row.addEventListener('click', () => setDetail(row));
        });

        approveButton.addEventListener('click', () => {
            errorBox.textContent = '';
            // 승인 로직 연결 시 이곳에서 처리
        });

        rejectButton.addEventListener('click', () => {
            if (!commentField.value.trim()) {
                errorBox.textContent = '반려 사유를 입력해주세요.';
                commentField.focus();
                return;
            }
            errorBox.textContent = '';
            // 반려 처리 로직 추가 가능
        });

        commentField.addEventListener('input', () => {
            if (commentField.value.trim()) {
                errorBox.textContent = '';
            }
        });

        if (rows.length) {
            setDetail(rows[0]);
        }
        updateOverviewCounts();
    });
</script>
    <!-- 사이드바 스크립트 -->
    <div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
</body>
</html>

