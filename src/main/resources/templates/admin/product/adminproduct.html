<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>펀드 목록 - 은행 펀드 상품 관리자</title>
    <link rel="stylesheet" th:href="@{/css/admin/admin_styles.css}">
    <link rel="stylesheet" th:href="@{/css/admin/adminproduct.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<!--
    날짜 : 2025/11/24
    이름 : 이종봉
    내용 : 펀드 목록 상세(돋보기)
-->
<body>
    <!-- 사이드바 Fragment -->
    <div th:replace="~{admin/_sidebar :: sidebar('product-list')}"></div>

    <div class="main-content">
        <!-- 헤더 Fragment -->
        <div th:replace="~{admin/_header :: header}"></div>
        <div class="main-content-body">
            <div class="container">
            <!-- 페이지 헤더 -->
            <header class="page-header">
                <h1>펀드 목록</h1>
                <div class="header-actions">
                    <a th:href="@{/admin/product/pending}" class="btn btn-red">펀드관리</a>
                </div>
            </header>

            <!-- 검색 섹션 -->
            <div class="search-section">
                <form th:action="@{/admin/product}" method="get" style="margin: 0;">
                    <table class="search-table">
                        <tbody>
                            <tr>
                                <td class="search-label">검색조건</td>
                                <td class="search-inputs">
                                    <select class="form-select search-select-small" id="searchNameSelect" name="searchType">
                                        <option value="name">펀드명</option>
                                        <option value="code">상품코드</option>
                                        <option value="type">유형</option>
                                    </select>
                                    <input type="text" class="form-input search-input-large" id="searchName" name="keyword" placeholder="입력하세요" th:value="${pageRequestDTO != null ? pageRequestDTO.keyword : ''}">
                                </td>
                            </tr>
                            <tr>
                                <td class="search-label">펀드분류</td>
                                <td class="search-inputs">
                                    <select class="form-select search-select-medium" id="searchCategory" name="category">
                                        <option value="">전체</option>
                                        <option value="주식형">주식형</option>
                                        <option value="채권형">채권형</option>
                                        <option value="혼합형">혼합형</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="search-label">상태</td>
                                <td class="search-inputs">
                                    <div class="status-radio-group">
                                        <label class="status-radio-label">
                                            <input type="radio" name="status" value="" checked>
                                            <span>전체</span>
                                        </label>
                                        <label class="status-radio-label">
                                            <input type="radio" name="status" value="게시중">
                                            <span>게시중</span>
                                        </label>
                                        <label class="status-radio-label">
                                            <input type="radio" name="status" value="수정중">
                                            <span>수정중</span>
                                        </label>
                                        <label class="status-radio-label">
                                            <input type="radio" name="status" value="대기중">
                                            <span>대기중</span>
                                        </label>
                                        <label class="status-radio-label">
                                            <input type="radio" name="status" value="중단">
                                            <span>중단</span>
                                        </label>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="search-actions">
                        <button class="btn btn-search" type="submit">조회</button>
                        <button class="btn btn-secondary" type="button" th:onclick="|location.href='@{/admin/product}'|">초기화</button>
                    </div>
                </form>
            </div>

            <!-- 상품 목록 테이블 -->

            <div class="table-section">
                <div class="table-info">
                    <span>
                            총
                            <strong th:text="${pageResponse != null ? pageResponse.total : 0}">0</strong>건
                        </span>
                    <span class="pagination-info"
                          th:if="${pageResponse != null and pageResponse.total > 0}">
                            현재:
                            <span th:text="${pageRequestDTO.pg}">1</span> /
                            <span th:text="${(pageResponse.total + pageRequestDTO.size - 1) / pageRequestDTO.size}">1</span>
                            페이지
                        </span>
                </div>
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>번호</th>
                            <th>상품코드</th>
                            <th>유형</th>
                            <th>상품명</th>
                            <th></th>
                            <th>회사명</th>
                            <th>등록일자</th>
                            <th>상태</th>
                            <th>상품관리</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr th:each="dtoList, stat : ${dtoList}">
                            <td th:text="${stat.index + 1}"></td>
                            <td th:text="${dtoList.fundCode}"></td>
                            <td th:text="${dtoList.categoryName}"></td>
                            <td th:text="${dtoList.fundName}"></td>
                            <td>
                                <button class="view-detail-btn" th:attr="data-fund-code=${dtoList.fundCode}"
                                        onclick="viewProductDetail(this.dataset.fundCode)" title="상세보기">
                                    <i class="fa fa-search"></i>
                                </button>
                            </td>
                            <td th:text="${dtoList.operatorName}"></td>
                            <td th:text="${#temporals.format(dtoList.regDate, 'yyyy-MM-dd')}"></td>
                            <td><span class="status-badge modifying" th:text="${dtoList.operStatus}"></span></td>
<!--                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn resume" onclick="resumeProduct(4)">재개</button>
                                    <button class="action-btn stop" onclick="endProduct(4)">상품종료</button>
                                </div>
                            </td>-->
                            <td>
                                <div class="action-buttons">
                                    <a th:href="@{/admin/product/pending}" class="btn btn-gry">펀드관리</a>
                                </div>
                            </td>

                        </tr>




                    </tbody>
                </table>
                <!-- 페이징 -->
                <div class="pagination"
                     th:if="${pageResponse != null and pageResponse.total > 0}">

                    <!-- 이전 버튼 -->
                    <button class="page-btn prev"
                            th:if="${pageResponse.prev}"
                            th:onclick="|location.href='@{/admin/product(
                            pg=${pageResponse.start - 1},
                            size=${pageRequestDTO.size},
                            searchType=${pageRequestDTO.searchType},
                            keyword=${pageRequestDTO.keyword},
                            category=${pageRequestDTO.category},
                            status=${pageRequestDTO.status}
                            )}'|">
                        &lt;
                    </button>

                    <!-- 페이지 번호 -->
                    <div class="page-numbers">
                        <button class="page-number"
                                th:each="p : ${#numbers.sequence(pageResponse.start, pageResponse.end)}"
                                th:text="${p}"
                                th:classappend="${p == pageRequestDTO.pg} ? ' active'"
                                th:onclick="|location.href='@{/admin/product(
                                pg=${p},
                                size=${pageRequestDTO.size},
                                searchType=${pageRequestDTO.searchType},
                                keyword=${pageRequestDTO.keyword},
                                category=${pageRequestDTO.category},
                                status=${pageRequestDTO.status}
                                )}'|">
                        </button>
                    </div>

                    <!-- 다음 버튼 -->
                    <button class="page-btn next"
                            th:if="${pageResponse.next}"
                            th:onclick="|location.href='@{/admin/product(
                            pg=${pageResponse.end + 1},
                            size=${pageRequestDTO.size},
                            searchType=${pageRequestDTO.searchType},
                            keyword=${pageRequestDTO.keyword},
                            category=${pageRequestDTO.category},
                            status=${pageRequestDTO.status}
                            )}'|">
                        &gt;
                    </button>

                </div>




            </div>
            <!-- 푸터 영역 -->
            <footer class="admin-footer"></footer>
        </div>
        </div>
    </div>

    <!-- 상품 세부사항 모달 -->
    <div id="productDetailModal" class="modal">
        <div class="modal-content fund-detail-modal">
            <div class="modal-header">
                <div class="fund-detail-title">
                    <h2>펀드요약정보</h2>
                    <div class="fund-name-section">
                        <div class="fund-full-name" id="fundFullName"></div>
                        <div class="fund-code" id="fundCode"></div>
                    </div>
                </div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 상품 상세 정보가 여기에 표시됩니다 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">닫기</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // 돋보기 클릭 → 모달 열기 + DB에서 상세 조회
        function viewProductDetail(fundCode) {

            fetch(`/bnk/admin/product/detail?fundCode=` + fundCode)
                .then(res => {
                    if (!res.ok) throw new Error("서버 오류");
                    return res.json();
                })
                .then(product => {

                    if (!product) {
                        alert("상품 정보를 찾을 수 없습니다.");
                        return;
                    }

                    // 모달 헤더
                    document.getElementById("fundFullName").textContent = product.fundName;
                    document.getElementById("fundCode").textContent = product.fundCode;

                    // 모달 본문 영역 생성
                    const modalBody = document.getElementById("modalBody");

                    modalBody.innerHTML = `
                <!-- PDF 문서 -->
<div class="pdf-documents-section">
    <div class="pdf-document-item"><i class="fa fa-file-pdf"></i><span>약관</span></div>
    <div class="pdf-document-item"><i class="fa fa-file-pdf"></i><span>투자설명서</span></div>
    <div class="pdf-document-item"><i class="fa fa-file-pdf"></i><span>간이 투자설명서</span></div>
</div>

<div class="fund-info-section">

    <!-- 회사 탭 -->
    <div class="company-info-section">
        <div class="company-tabs">
            <button class="company-tab-btn active"
                onclick="switchCompanyTab('logo', this)">회사로고</button>
            <button class="company-tab-btn"
                onclick="switchCompanyTab('overview', this)">회사개황</button>
            <button class="company-tab-btn"
                onclick="switchCompanyTab('financial', this)">주요재무현황</button>
        </div>

        <!-- 회사로고 -->
        <div class="company-tab-content" id="companyLogoTab">
            <div class="company-logo-container">
                <img src="/images/company-logo.png" class="company-logo-img">
            </div>
        </div>

        <!-- 회사개황 -->
        <div class="company-tab-content" id="companyOverviewTab" style="display:none;">
            <div class="company-overview-table">
                <div class="overview-row"><div class="overview-label">설립일</div><div class="overview-value">${product.establishmentDate || '-'}</div></div>
                <div class="overview-row"><div class="overview-label">대표전화</div><div class="overview-value">${product.operatorHp || '-'}</div></div>
                <div class="overview-row"><div class="overview-label">자본금</div><div class="overview-value">${product.capital || '-'}</div></div>
                <div class="overview-row"><div class="overview-label">홈페이지</div><div class="overview-value">${product.homepageUrl || '-'}</div></div>
            </div>
        </div>

        <!-- 재무현황 -->
        <div class="company-tab-content" id="companyFinancialTab" style="display:none;">
            <canvas id="financialChart"></canvas>
        </div>
    </div>


    <!-- 기준가/전일/전주 비교 -->
    <div class="fund-price-section">
        <div class="standard-price">
            <div class="price-label">기준가</div>
            <div class="price-value">${product.navPerUnit || '-'}</div>
        </div>

        <div class="price-comparison">
            <div class="comparison-item">
                <div class="comparison-label">전일대비</div>
                <div class="comparison-value">${product.changeAmount || '-'} (${product.dailyChangeRate || '-'})</div>
            </div>
            <div class="comparison-item">
                <div class="comparison-label">전주대비</div>
                <div class="comparison-value">- (-)</div>
            </div>
            <div class="reference-date">기준일: ${product.tradeDate || '-'}</div>
        </div>
    </div>


    <!-- 펀드 기본 정보 -->
    <div class="fund-details-table">
        <table class="detail-table">
            <tr><td>펀드유형</td><td>${product.fundType}</td></tr>
            <tr><td>투자지역</td><td>${product.investRegion}</td></tr>
            <tr><td>단축코드</td><td>${product.shortCode}</td></tr>
            <tr><td>총보수</td><td>${product.totalExpenseRatio}</td></tr>
            <tr><td>최초설정일</td><td>${product.setupDate}</td></tr>
            <tr><td>설정원본</td><td>${product.initialNav}</td></tr>
            <tr><td>순자산총액</td><td>${product.totalNav}</td></tr>
            <tr><td>운용상태</td><td>${product.operStatus}</td></tr>
        </table>
    </div>

</div>


<!-- ===================== -->
<!-- 하단 상세 탭 -->
<!-- ===================== -->

<div class="fund-tabs-nav">
    <button class="fund-tab-btn active" onclick="switchFundTab('basic', this)">펀드기본정보</button>
    <button class="fund-tab-btn" onclick="switchFundTab('chart', this)">수익률 추이차트</button>
    <button class="fund-tab-btn" onclick="switchFundTab('price', this)">가격변동 추이</button>
    <button class="fund-tab-btn" onclick="switchFundTab('asset', this)">자산구성내역</button>
    <button class="fund-tab-btn" onclick="switchFundTab('settlement', this)">결산 및 상환</button>
    <button class="fund-tab-btn" onclick="switchFundTab('disclosure', this)">공시관련</button>
</div>


<div class="fund-detail-sections">

    <!-- 펀드기본정보 -->
    <div class="detail-section fund-tab-content" id="basicTab">
        <h3 class="section-subtitle">펀드기본정보</h3>
        <div class="detail-grid">
            <div class="detail-grid-item"><div class="detail-label">구분</div><div class="detail-value">${product.className}</div></div>
            <div class="detail-grid-item"><div class="detail-label">설정일</div><div class="detail-value">${product.setupDate}</div></div>
            <div class="detail-grid-item"><div class="detail-label">신탁회계기간</div><div class="detail-value">${product.operPeriodType}</div></div>
        </div>
    </div>

    <!-- 수익률 추이차트 -->
    <div class="detail-section fund-tab-content" id="chartTab" style="display:none;">
        <canvas id="chartCanvas"></canvas>
    </div>

    <!-- 가격변동 -->
    <div class="detail-section fund-tab-content" id="priceTab" style="display:none;">
        <p>가격변동 데이터 준비중</p>
    </div>

    <!-- 자산구성내역 -->
    <div class="detail-section fund-tab-content" id="assetTab" style="display:none;">
        <p>자산구성내역 데이터 준비중</p>
    </div>

    <!-- 결산 및 상환 -->
    <div class="detail-section fund-tab-content" id="settlementTab" style="display:none;">
        <p>결산 및 상환 정보 준비중</p>
    </div>

    <!-- 공시 관련 -->
    <div class="detail-section fund-tab-content" id="disclosureTab" style="display:none;">
        <p>공시자료 준비중</p>
    </div>

</div>
`;

                    document.getElementById("productDetailModal").classList.add("active");
                })
                .catch(err => {
                    console.error(err);
                    alert("상세정보 조회 중 오류 발생");
                });
}
        /* ===============================
            ■ 탭 스위칭 (회사/재무/기본정보)
        ================================*/
        function switchCompanyTab(tabName, element) {
            document.querySelectorAll(".company-tab-btn").forEach(btn => btn.classList.remove("active"));
            document.querySelectorAll(".company-tab-content").forEach(sec => sec.style.display = "none");

            element.classList.add("active");

            const target = {
                logo: "companyLogoTab",
                overview: "companyOverviewTab",
                financial: "companyFinancialTab"
            }[tabName];

            document.getElementById(target).style.display = "block";
        }

        /* ===============================
            ■ 펀드 상세 하단 탭
        ================================*/
        function switchFundTab(tabName, element) {

            document.querySelectorAll(".fund-tab-btn").forEach(btn => btn.classList.remove("active"));
            document.querySelectorAll(".fund-tab-content").forEach(sec => sec.style.display = "none");

            element.classList.add("active");

            document.getElementById(tabName + "Tab").style.display = "block";
        }

        /* ===============================
            ■ 모달 닫기
        ================================*/
        function closeModal() {
            document.getElementById("productDetailModal").classList.remove("active");
        }

        /*]]>*/
    </script>

    <!-- 사이드바 스크립트 -->
    <div th:replace="~{admin/_sidebar :: sidebar-script}"></div>
</body>
</html>

